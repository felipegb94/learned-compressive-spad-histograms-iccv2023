# Data Generation Code

Adapted from Lindell et al., 2018 and Peng et al. 2020.


## SPAD Measurement Simulation Pipeline

### Inputs

These are the files generated by `ConvertRGBD.m`

* `distance`: Per-pixel distance in meter
* `albedo`: Per-pixel albedo. Used to compute the *signal* photons. For NYUv2, this is computed using `intrinsic_decomp`
* `intensity`: Per-pixel ambient intensity. One of the channels of the aligned RGB image. 

### Steps taken in `SimulateTrainMeasurements`

1. Load `distance`, `albedo`, `intensity`.
2. Check if all pixels in `albedo` are valid, otherwise skip 
3. In-paint depths using `nyu_utils` if needed
4. Convert `distance` to `tof` (time-of-flight)
5. Convert `tof` to `bin` index
6. If any `bin` is outside range (0-max_n_bins), truncate them
7. Convert `albedo` to `alpha` which accounts for light fall-off
8. Take the `alpha` image set its mean to `mean_signal_photons`
8. Take the `intensity` image and set its mean to `mean_ambient_photons`
9. Take the laser pulse waveform (`psf` or `irf`), scale it with `alpha`, and apply constant offset with `intensity`
10. Finally for each pixel in the 3D histogram image from step 9, but the `bin`.
11. Sample Poisson process. 